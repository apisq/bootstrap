AWSTemplateFormatVersion: '2010-09-09'
Description: Core resources for apisq (https://github.com/apisq/bootstrap)

Parameters:
  CustomDomainName:
    Type: String
    Default: ''
  CustomDomainCertId:
    Type: String
    Default: ''

Conditions:
  HasCustomDomain:
    Fn::And:
      - Fn::Not: [{ Fn::Equals: [{ Ref: CustomDomainName }, ''] }]
      - Fn::Not: [{ Fn::Equals: [{ Ref: CustomDomainCertId }, ''] }]

Resources:

  AssetsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: ${AWS::StackName}-${AWS::Region}-${AWS::AccountId}
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID:
                Ref: AssetsBucketKmsKey
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  AssetsBucketKmsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: ${AWS::StackName} KMS key for Assets bucket
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowRootAccountAdmin
            Effect: Allow
            Principal:
              AWS:
                Fn::Sub: arn:aws:iam::${AWS::AccountId}:root
            Action: kms:*
            Resource: '*'
          - Sid: AllowS3UseForSpecificBucketOnly
            Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: '*'
            Condition:
              StringEquals:
                aws:SourceAccount:
                  Ref: AWS::AccountId
              ArnEquals:
                aws:SourceArn:
                  Fn::Sub: arn:aws:s3:::${AWS::StackName}-${AWS::Region}-${AWS::AccountId}

  AssetsBucketKmsAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName:
        Fn::Sub: alias/${AWS::StackName}-${AWS::Region}-${AWS::AccountId}
      TargetKeyId:
        Ref: AssetsBucketKmsKey

  CustomDomain:
    Type: AWS::ApiGateway::DomainName
    Condition: HasCustomDomain
    Properties:
      DomainName:
        Ref:  CustomDomainName
      EndpointConfiguration:
        Types: [REGIONAL]
      SecurityPolicy: TLS_1_2
      RegionalCertificateArn:
        Fn::Sub: arn:aws:acm:${AWS::Region}:${AWS::AccountId}:certificate/${CustomDomainCertId}

  DeployRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Sub: ${AWS::StackName}-deploy-role
      Description: Execution role assumed by CloudFormation to deploy apisq resources
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - Ref: DeployPolicy1
        - Ref: DeployPolicy2

  DeployPolicy1:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName:
        Fn::Sub: ${AWS::StackName}-deploy-policy-1
      Description: (Policy 1) Generic read permissions
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "ec2:Describe*"
            Resource: "*"
          - Effect: Allow
            Action: logs:DescribeLogGroups
            Resource:
              Fn::Sub:  "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group::log-stream:"

  DeployPolicy2:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName:
        Fn::Sub: ${AWS::StackName}-deploy-policy-2
      Description: (Policy 2) Deploy resources permissions
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          # Allow all Lambda actions
          - Effect: Allow
            Action: lambda:*
            Resource:
              Fn::Sub: 'arn:aws:lambda:*:${AWS::AccountId}:function:apisq-*'
          # Except Invoke*
          - Effect: Deny
            Action: lambda:Invoke*
            Resource: '*'

          # Allow all DynamoDB actions
          - Effect: Allow
            Action: dynamodb:*
            Resource:
              - Fn::Sub: 'arn:aws:dynamodb:*:${AWS::AccountId}:table:apisq-*'
              - Fn::Sub: 'arn:aws:dynamodb::${AWS::AccountId}:global-table:apisq-*'
          # Except *Item actions
          - Effect: Deny
            Action: dynamodb:*Item
            Resource: '*'

          # Allow API-Gateway permissions
          - Effect: Allow
            Action: apigateway:*
            Resource: '*'

          # Allow Cloudwatch Logs permissions
          - Effect: Allow
            Action: logs:*
            Resource:
              - Fn::Sub: 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:*apisq-*'
              - Fn::Sub: 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:*apisq-*:log-stream:'
              - Fn::Sub: 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:*apisq-*:log-stream:*'

          # Allow Eventbridge permissions
          - Effect: Allow
            Action: events:*
            Resource:
              - Fn::Sub: arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/apisq-*
              - Fn::Sub: arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/*/apisq-*
          # Except PutEvents action
          - Effect: Deny
            Action: events:PutEvents
            Resource: '*'

          # Allow the IAM CreateRole action only if the permission boundary is set
          - Effect: Allow
            Action:
              - iam:CreateRole
              - iam:PutRolePermissionsBoundary
            Resource:
              Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/apisq-execution-*-role
            Condition:
              StringEquals:
                iam:PermissionsBoundary:
                  Ref: PermssionBoundaryPolicy
          # Allow specific IAM actions targeting the execution roles
          - Effect: Allow
            Action:
              - iam:GetRole*
              - iam:ListRole*
              - iam:DeleteRole
              - iam:PutRolePolicy
              - iam:DeleteRolePolicy
              - iam:TagRole
              - iam:UntagRole
              - iam:PassRole
            Resource:
              - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/apisq-execution-*-role

  DeployPolicy3:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName:
        Fn::Sub: ${AWS::StackName}-deploy-policy-3
      Description: (Policy 3) Deploy resources permissions
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          # Allow all Secret Manager actions
          - Effect: Allow
            Action: secretsmanager:*
            Resource:
              Fn::Sub: arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:apisq-*

          # Allow all SSM Parameter Store actions
          - Effect: Allow
            Action: ssm:*Parameter*
            Resource:
              Fn::Sub: arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/apisq/*

          # Allow all Step Functions actions
          - Effect: Allow
            Action: states:*
            Resource:
              Fn::Sub: arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:apisq-*

  PermssionBoundaryPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName:
        Fn::Sub: ${AWS::StackName}-permissions-policy
      Description: (Policy 3) Deploy resources permissions
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:

              # API-Gateway
              - apigateway:GET
              - execute-api:Invoke

              # Cloudwatch Logs
              - logs:DescribeLogGroups
              - logs:DescribeLogStreams
              - logs:FilterLogEvents
              - logs:GetLogEvents
              - logs:GetQueryResults
              - logs:StartQuery

              # DynamoDB
              - dynamodb:BatchGetItem
              - dynamodb:BatchWriteItem
              - dynamodb:GetItem
              - dynamodb:PutItem
              - dynamodb:Query
              - dynamodb:Scan
              - dynamodb:UpdateItem

              # EventBridge
              - events:ListEventBuses
              - events:ListRules
              - events:PutEvents

              # KMS
              - kms:DescribeKey
              - kms:Decrypt
              - kms:Encrypt
              - kms:GenerateDataKey*

              # Lambda
              - lambda:InvokeFunction
              - lambda:InvokeFunctionUrl

              # Parameter Store
              - ssm:GetParameter
              - ssm:GetParameters
              - ssm:GetParametersByPath
              - ssm:DescribeParameters

              # RDS
              - rds-data:BatchExecuteStatement
              - rds-data:BeginTransaction
              - rds-data:CommitTransaction
              - rds-data:ExecuteStatement
              - rds-data:ListDatabases
              - rds-data:ListSchemas
              - rds-data:ListTables
              - rds-data:RollbackTransaction
              - rds:DescribeDBClusters
              - rds:DescribeDBInstances

              # S3
              - s3:DeleteObject
              - s3:GetObject
              - s3:ListBucket
              - s3:PutObject

              # Secrets Manager
              - secretsmanager:DescribeSecret
              - secretsmanager:GetResourcePolicy
              - secretsmanager:GetSecretValue
              - secretsmanager:ListSecrets

              # SNS
              - sns:GetSubscriptionAttributes
              - sns:GetTopicAttributes
              - sns:ListSubscriptionsByTopic
              - sns:ListTopics
              - sns:Publish
              - sns:Subscribe
              - sns:Unsubscribe

              # SQS
              - sqs:ChangeMessageVisibility
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:ListQueues
              - sqs:ListQueueTags
              - sqs:PurgeQueue
              - sqs:ReceiveMessage
              - sqs:SendMessage

              # Step Functions
              - states:DescribeExecution
              - states:DescribeStateMachine
              - states:GetExecutionHistory
              - states:ListExecutions
              - states:ListStateMachines
              - states:StartExecution

            Resource: '*'

Outputs:
  Version:
    Description: Bootstrap version
    Value: '1.0.0'
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-version
  AssetsBucketName:
    Description: Bucket Name
    Value:
      Ref: AssetsBucket
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-assets-bucket
  AssetsBucketArn:
    Description: Bucket ARN
    Value:
      Fn::GetAtt: [AssetsBucket, Arn]
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-assets-bucket-arn
  DeployRoleName:
    Description: Deploy Role Name
    Value:
      Ref: DeployRole
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-deploy-role
  DeployRoleArn:
    Description: Deploy Role ARN
    Value:
      Fn::GetAtt: [DeployRole, Arn]
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-deploy-role-arn
  ExecutionPermissionsBoundary:
    Description: Execution Role Permission Boundary
    Value:
      Fn::Sub: ${AWS::StackName}-permissions-policy
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-execution-permission-boundary
  CustomDomainName:
    Description: Custom Domain Name
    Condition: HasCustomDomain
    Value:
      Ref: CustomDomain
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-custom-domain
  CustomDomainArn:
    Description: Custom Domain ARN
    Condition: HasCustomDomain
    Value:
      Fn::GetAtt: [CustomDomain, DomainNameArn]
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-custom-domain-arn
